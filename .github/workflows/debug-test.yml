name: Debug Test

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Check secrets availability
      env:
        README_GITHUB_TOKEN: ${{ secrets.README_GITHUB_TOKEN }}
        README_CLAUDE_TOKEN: ${{ secrets.README_CLAUDE_TOKEN }}
      run: |
        echo "=== SECRET CHECK ==="
        echo "README_GITHUB_TOKEN exists: ${{ secrets.README_GITHUB_TOKEN != '' }}"
        echo "README_CLAUDE_TOKEN exists: ${{ secrets.README_CLAUDE_TOKEN != '' }}"
        
        if [ -z "$README_GITHUB_TOKEN" ]; then
          echo "ERROR: README_GITHUB_TOKEN is empty in environment"
        else
          echo "✓ README_GITHUB_TOKEN is set (length: ${#README_GITHUB_TOKEN})"
        fi
        
        if [ -z "$README_CLAUDE_TOKEN" ]; then
          echo "ERROR: README_CLAUDE_TOKEN is empty in environment"
        else
          echo "✓ README_CLAUDE_TOKEN is set (length: ${#README_CLAUDE_TOKEN})"
        fi
    
    - name: Test Python environment
      run: |
        echo "=== PYTHON VERSION ==="
        python3 --version
        
        echo "=== INSTALLING PACKAGES ==="
        python -m pip install --upgrade pip
        pip install python-graphql-client requests
        
        echo "=== CHECKING IMPORTS ==="
        python3 << 'EOF'
import sys
try:
    from python_graphql_client import GraphqlClient
    print("✓ python-graphql-client imported")
except ImportError as e:
    print(f"✗ Failed to import python-graphql-client: {e}")
    sys.exit(1)

try:
    import requests
    print("✓ requests imported")
except ImportError as e:
    print(f"✗ Failed to import requests: {e}")
    sys.exit(1)

print("All imports successful!")
EOF
    
    - name: Test GitHub Token
      env:
        README_GITHUB_TOKEN: ${{ secrets.README_GITHUB_TOKEN }}
      run: |
        echo "=== TESTING GITHUB TOKEN ==="
        python3 << 'EOF'
import os
import sys
from python_graphql_client import GraphqlClient

token = os.environ.get("README_GITHUB_TOKEN")
if not token:
    print("ERROR: Token not available")
    sys.exit(1)

print(f"Token length: {len(token)}")

client = GraphqlClient(endpoint="https://api.github.com/graphql")

# Simple query to test token
query = """
query {
  viewer {
    login
  }
}
"""

try:
    headers = {
        "Authorization": f"Bearer {token}",
        "Accept": "application/vnd.github.v4+json"
    }
    response = client.execute(query=query, headers=headers)
    
    if "errors" in response:
        print(f"GraphQL errors: {response['errors']}")
        sys.exit(1)
    
    print(f"✓ GitHub Token is valid!")
    print(f"✓ Authenticated as: {response['data']['viewer']['login']}")
except Exception as e:
    print(f"✗ Error testing token: {e}")
    import traceback
    traceback.print_exc()
    sys.exit(1)
EOF
    
    - name: Test Claude Token
      env:
        README_CLAUDE_TOKEN: ${{ secrets.README_CLAUDE_TOKEN }}
      run: |
        echo "=== TESTING CLAUDE TOKEN ==="
        python3 << 'EOF'
import os
import sys
import requests

token = os.environ.get("README_CLAUDE_TOKEN")
if not token:
    print("ERROR: Token not available")
    sys.exit(1)

print(f"Token length: {len(token)}")

headers = {
    "x-api-key": token,
    "anthropic-version": "2023-06-01",
    "content-type": "application/json"
}

data = {
    "model": "claude-haiku-4-5-20251001",
    "max_tokens": 10,
    "messages": [{"role": "user", "content": "Say 'test'"}]
}

try:
    response = requests.post(
        "https://api.anthropic.com/v1/messages",
        headers=headers,
        json=data,
        timeout=30
    )
    
    print(f"Response status code: {response.status_code}")
    
    if response.status_code == 200:
        print("✓ Claude API Token is valid!")
    else:
        print(f"✗ Claude API error: {response.status_code}")
        print(f"Response: {response.text}")
        sys.exit(1)
except Exception as e:
    print(f"✗ Error testing Claude token: {e}")
    import traceback
    traceback.print_exc()
    sys.exit(1)
EOF

